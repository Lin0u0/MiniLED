# MiniLED 分区背光控制器 技术文档

## 目录
1. [项目概述](#项目概述)
2. [硬件架构](#硬件架构)
3. [系统架构](#系统架构)
4. [关键模块详解](#关键模块详解)
5. [数据流分析](#数据流分析)
6. [控制逻辑](#控制逻辑)
7. [算法原理](#算法原理)
8. [使用指南](#使用指南)
9. [开发扩展](#开发扩展)

---

## 项目概述

### 项目简介
MiniLED 分区背光控制器是基于 **高云 GW2A-55 FPGA** 的实时图像处理系统，用于驱动 360 分区 (24×15) 的 MiniLED 背光面板，实现 LCD 屏幕的动态背光控制。

### 核心特性
| 特性 | 规格 |
|------|------|
| FPGA 芯片 | GW2A-LV55PG484C8/I7 (BGA484) |
| 分区数量 | 360 区 (24列 × 15行) |
| 支持分辨率 | 1280×800 @ 60Hz |
| 输入接口 | LVDS 7:1 (2组) |
| 输出接口 | LVDS 7:1 + SPI7001 LED 驱动 |
| 算法模式 | RMS / Max / Ave / Correction |
| 背光模式 | 全区固定 / 分区动态 / 自动亮度 |
| 传感器 | AP3216 环境光传感器 (I2C) |

### 项目结构
```
MiniLED/
├── src/                          # 源代码
│   ├── miniled_top.v            # 顶层模块
│   ├── MiniLED_driver.v         # LED 驱动控制
│   ├── ramflag_In.v             # 背光计算核心
│   ├── miniled.cst              # 管脚约束
│   ├── algorithm/               # 算法模块
│   │   ├── block_360_pro.v     # 360分区背光算法
│   │   └── rgb_to_gray.v       # RGB转灰度
│   ├── lvds_7to1_rx/           # LVDS 接收
│   ├── lvds_7to1_tx/           # LVDS 发送
│   ├── i2c/                     # I2C 传感器驱动
│   ├── utils/                   # 工具模块
│   │   └── key_debounce.v      # 按键消抖
│   └── CONTROL_README.md       # 控制说明
├── doc/                         # 硬件文档
│   └── Mini_LED分区背光开发套件用户手册V3.pdf
├── docs/                        # 技术文档
│   └── 技术文档.md              # 本文件
├── miniled.gprj                # 高云工程文件
└── README.md                   # 项目说明
```

---

## 硬件架构

### 开发板架构
开发套件采用 **核心板 + 底板** 架构：

```
┌─────────────────────────────────────────┐
│              核心板 (Core Board)         │
│  ┌─────────┐  ┌─────┐  ┌─────────────┐  │
│  │ GW2A-55 │  │ DDR3│  │ 128M FLASH  │  │
│  │  FPGA   │  │ 2G  │  │  GD25Q128   │  │
│  └────┬────┘  └─────┘  └─────────────┘  │
│       │                                 │
│       └─ 2×30PIN 排座连接底板           │
└─────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│              底板 (Base Board)           │
│  ┌────────┐ ┌────────┐ ┌────────────┐  │
│  │LVDS RX │ │LVDS TX │ │ SPI7001    │  │
│  │ 输入×2 │ │ 输出×2 │ │ LED驱动×2  │  │
│  └────────┘ └────────┘ └────────────┘  │
│  ┌────────┐ ┌────────┐ ┌────────────┐  │
│  │AP3216  │ │ 按键×4 │ │ LED×4      │  │
│  │光感    │ │ 拨码×2 │ │ 指示       │  │
│  └────────┘ └────────┘ └────────────┘  │
└─────────────────────────────────────────┘
```

### 信号链路

```
视频源 ──LVDS──► FPGA ──LVDS──► LCD面板
                    │
                    └──SPI──► MiniLED灯板 (360分区)
                    │
                    └──I2C──► AP3216光感
```

### 关键硬件参数

#### FPGA 资源 (GW2A-55)
| 资源 | 数量 |
|------|------|
| LUTs | 55,936 |
| 寄存器 | 55,936 |
| SRAM | 1,192 Kb |
| DSP | 32 |
| PLL | 4 |
| 用户 I/O | 270 |

#### 电源分配
| 电压 | 用途 |
|------|------|
| 3.3V | Bank 2/5/6, SPI, LED 驱动 |
| 2.5V | Bank 0/1/3/4, LVDS |
| 1.5V | Bank 7, DDR3 |
| 1.0V | 内核电压 |

---

## 系统架构

### 顶层架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        miniled_top                          │
│                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │  LVDS_RX     │    │  RGB2Gray    │    │  LVDS_TX     │  │
│  │  7:1解码     │───►│  灰度转换    │───►│  7:1编码     │  │
│  └──────────────┘    └──────┬───────┘    └──────────────┘  │
│                             │                               │
│                             ▼                               │
│                    ┌──────────────────┐                     │
│                    │  block_360_pro   │                     │
│                    │  360分区背光算法  │                     │
│                    └────────┬─────────┘                     │
│                             │                               │
│                             ▼                               │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │   AP3216     │    │  ramflag_In  │    │ SPI7001驱动  │  │
│  │  光感采集    │───►│  背光计算    │───►│  LED控制     │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│                                                             │
│  控制接口: 拨码开关(SW1/SW2) + 按键(KEY1-4)                   │
└─────────────────────────────────────────────────────────────┘
```

### 时钟架构

```
输入时钟 (50MHz)
    │
    ├──► PLL ──► 25MHz ──► SPI7001 LED驱动时钟
    │              │
    │              └──► 1MHz ──► SPI 配置时钟
    │
    └──► LVDS_RX_PLL ──► 像素时钟 (约50MHz for 1280×800@60)
              │
              └──► 用于视频数据处理
```

---

## 关键模块详解

### 1. LVDS_7to1_RX_Top (LVDS 接收)

**功能**: 将 7:1 串行 LVDS 信号解码为并行 RGB 数据

**工作原理**:
```
LVDS 7:1 是一种视频传输标准，7个串行 bit 代表 1个并行字节

输入: 4对数据差分线 + 1对时钟差分线
       ├─ 3对用于 RGB 数据 (R/G/B 各用一对，7:1压缩)
       └─ 1对用于控制信号 (HSYNC/VSYNC/DE)

输出: 8-bit R + 8-bit G + 8-bit B + 同步信号
```

**关键子模块**:
- `LVDS_RX_rPLL`: 时钟恢复 PLL
- `bit_align_ctl`: 位对齐控制
- `word_align_ctl`: 字对齐控制

---

### 2. rgb_to_data_gray (RGB转灰度)

**功能**: 将 RGB888 转换为 8-bit 灰度值

**转换公式**:
```verilog
// 标准 ITU-R BT.601 系数
data_gray = (R * 76 + G * 150 + B * 29) >> 8;
// 即: Gray = 0.299*R + 0.587*G + 0.114*B
```

**时序**:
- 输入: RGB + DE (数据使能)
- 输出: 8-bit 灰度 + 像素坐标 (pix_x, pix_y)
- 延迟: 2-3 时钟周期

---

### 3. block_360_pro (360分区背光算法)

这是项目的**核心算法模块**。

#### 分区映射关系
```
屏幕分辨率: 1280×800
分区布局: 24列 × 15行 = 360区

每区像素数:
- 水平: 1280 / 24 ≈ 53.33 像素
- 垂直: 800 / 15 ≈ 53.33 像素

实际实现: 使用像素坐标计算分区号
cnt_h24 = pix_x / 53;  // 0-23
cnt_v15 = pix_y / 53;  // 0-14
cnt_360 = cnt_v15 * 24 + cnt_h24;  // 0-359
```

#### 算法流程

```
1. 帧开始 (Vsync上升沿)
   └── 清空累加器

2. 逐像素处理 (每个时钟周期)
   ├── 计算当前像素所属分区 (cnt_h24, cnt_v15)
   ├── 根据 gray_mode 选择算法:
   │   ├── RMS:   累加平方和
   │   ├── Max:   记录最大值
   │   ├── Ave:   累加求和
   │   └── Cor:   应用校正系数
   └── 更新对应分区的统计值

3. 帧结束 (Vsync下降沿)
   ├── 计算各分区最终亮度
   │   ├── RMS:   sqrt(平方和/像素数)
   │   ├── Max:   最大值
   │   ├── Ave:   平均值
   │   └── Cor:   校正后值
   ├── 应用 6帧时间滤波 (temporal filter)
   └── 输出到下一级
```

#### 关键数据结构
```verilog
// 水平累加器 (24列)
reg [23:0] rms_sum_h;           // RMS: 每行水平方向平方和
reg [7:0]  BL_max_tmp[24:0];    // Max: 每行水平方向最大值

// 垂直累加器 (24×15)
reg [24*24-1:0] rms_sum_v;      // RMS: 每列垂直方向平方和
reg [7:0]  BL_max[360-1:0];     // Max: 每区最大值
reg [15:0] buf_360_fore[6-1:0][360-1:0];  // 6帧历史缓冲区
```

#### 牛顿迭代法开方 (RMS模式)
```verilog
function [7:0] isqrt_approx;
    input [23:0] x;
    reg [7:0] guess;
    reg [15:0] quotient;
    begin
        if (x == 0) 
            isqrt_approx = 0;
        else begin
            // 初始猜测值
            guess = x[15:8] + 1;
            // 牛顿迭代: guess = (guess + x/guess) / 2
            quotient = x / guess;
            isqrt_approx = (guess + quotient[7:0]) >> 1;
        end
    end
endfunction
```

---

### 4. ramflag_In (背光计算核心)

**功能**: 根据控制信号计算最终 LED 亮度并输出到驱动芯片

#### 控制信号
```verilog
input I_zonal_en;       // 分区背光使能 (来自拨码开关SW1)
input I_auto_bright;    // 自动亮度使能 (来自拨码开关SW2)
input [1:0] I_sub_mode; // 子模式 (当前固定为11)
input [7:0] I_bright;   // 环境光亮度 (来自AP3216)
```

#### 亮度计算公式
```
// 步骤1: 基础亮度
if (!I_zonal_en)
    base = 224 * 255;  // 全区固定亮度
else
    base = light_reg[zone] * 255;  // 分区动态亮度

// 步骤2: 应用自动亮度
if (I_auto_bright && I_zonal_en)
    final = (base * I_bright) >> 8;  // 乘以光感系数
else
    final = base;
```

#### SPI7001 时序生成
```
每 16.8ms (60Hz) 发送一帧数据:
1. 发送 sdbpflag 脉冲 (帧起始)
2. 依次写入 360 个分区亮度值
3. 每个值 16-bit (实际使用 8-bit 有效)
4. 通过 SPI 接口 (SDI/DCLK/LE/GCLK) 输出
```

---

### 5. AP3216_driver (光感驱动)

**功能**: 通过 I2C 读取 AP3216C 环境光传感器

**工作流程**:
```
1. 初始化 (复位后)
   ├── 写寄存器 0x00 = 0x01 (系统复位)
   ├── 写寄存器 0x00 = 0x03 (ALS+IR active)
   └── 写寄存器 0x10 = 0x00 (ALS 动态范围)

2. 循环读取 (每 100ms)
   ├── 读寄存器 0x0C (ALS 低字节)
   ├── 读寄存器 0x0D (ALS 高字节)
   └── 合成 16-bit 亮度值 → I_bright
```

---

### 6. key_debounce (按键消抖)

**功能**: 消除机械按键的抖动，提供稳定的按键信号

**消抖原理**:
```
机械按键抖动特性:
按下时: ───┐   ┌─┐ ┌──┐  ┌───────────
          └───┘ └──┘  └────────
          │←─抖动 (~5-20ms)─→│

软件消抖方法:
1. 检测到电平变化
2. 开始计数 (50MHz 时钟)
3. 持续 10ms (500000 周期) 电平稳定
4. 确认按键有效
5. 输出下降沿/上升沿脉冲
```

**接口**:
```verilog
input  key_in;       // 原始按键输入 (低电平有效)
output key_out;      // 消抖后电平
output key_posedge;  // 上升沿脉冲 (释放)
output key_negedge;  // 下降沿脉冲 (按下)
```

---

## 数据流分析

### 完整数据流图

```
[视频源]
    │
    │ LVDS 7:1 差分信号
    ▼
┌─────────────────┐
│ LVDS_7to1_RX    │ ← 串并转换，时钟恢复
└────────┬────────┘
         │ RGB888 (24-bit) + DE + HSYNC + VSYNC
         ▼
┌─────────────────┐
│ rgb_to_data_gray│ ← RGB 转灰度
└────────┬────────┘
         │ 8-bit Gray + 像素坐标 (x,y)
         ▼
┌─────────────────┐
│ block_360_pro   │ ← 分区统计计算
│                 │   (RMS/Max/Ave/Cor)
└────────┬────────┘
         │ 360区亮度值 (8-bit × 360)
         ▼
┌─────────────────┐
│ ramflag_In      │ ← 应用控制参数
│                 │   (分区/自动亮度/子模式)
└────────┬────────┘
         │ SPI 数据流
         ▼
┌─────────────────┐
│ SPI7001_gowin   │ ← LED 驱动芯片时序
└────────┬────────┘
         │
         ▼
[MiniLED灯板] ← 360分区背光点亮

[旁路: AP3216] ──I2C──► [光感数据] ──► ramflag_In (自动亮度)
```

### 时序关系

| 阶段 | 时序 | 延迟 |
|------|------|------|
| LVDS 接收 | 像素时钟 | 2-3 周期 |
| RGB转灰度 | 每像素1周期 | 2-3 周期 |
| 分区统计 | 每帧累积 | 1帧 |
| 背光计算 | 帧结束计算 | <1ms |
| LED输出 | 16.8ms周期 | - |
| 总延迟 | - | 约 1-2 帧 (17-33ms) |

---

## 控制逻辑

### 控制架构

```
用户控制
    ├── 拨码开关 (SW1/SW2) ──► 背光功能控制 (实时)
    │                           ├── SW1: 分区背光开关
    │                           └── SW2: 自动亮度开关
    │
    └── 按键 (KEY1-4) ────────► 算法模式选择 (消抖)
                                ├── KEY1: RMS
                                ├── KEY2: Max
                                ├── KEY3: Ave
                                └── KEY4: Cor
```

### LED 指示语义

```
┌─────┬─────┬─────┬─────┐
│LED3 │LED2 │LED1 │LED0 │
├─────┼─────┼─────┼─────┤
│分区 │自动 │    算法模式    │
│背光 │亮度 │  00/01/10/11  │
└─────┴─────┴─────┴─────┘
```

### 真值表

| SW1 | SW2 | 背光模式 | LED3 | LED2 | 说明 |
|:---:|:---:|---------|:----:|:----:|------|
| OFF | OFF | 全区固定 | 灭 | 灭 | 最亮，耗电 |
| ON  | OFF | 纯分区 | 亮 | 灭 | 对比度好 |
| OFF | ON  | 全区+自动 | 灭 | 亮 | 不推荐 |
| ON  | ON  | 分区+自动 | 亮 | 亮 | **推荐** |

| 按键 | LED1:0 | 算法 | 特点 |
|:----:|:------:|------|------|
| KEY1 | 00 | RMS | 人眼感知最优 |
| KEY2 | 01 | Max | 对比度好 |
| KEY3 | 10 | Ave | 平滑 |
| KEY4 | 11 | Cor | 精确控制 |

---

## 算法原理

### 1. RMS (Root Mean Square) 均方根

**数学原理**:
```
对于每个分区内的 n 个像素:
RMS = sqrt( (pixel₁² + pixel₂² + ... + pixelₙ²) / n )
```

**物理意义**:
- 人眼对亮度的感知是非线性的 (近似平方关系)
- RMS 更接近主观亮度感受
- 暗场细节保留更好

**实现优化**:
- 使用 24-bit 累加器避免溢出
- 牛顿迭代法近似开方 (节省资源)
- 水平垂直两级累加减少存储

---

### 2. Max 最大值

**原理**:
```
BL = max(pixel₁, pixel₂, ..., pixelₙ)
```

**特点**:
- 保留最大对比度
- 可能出现光晕 (halo) 效应
- 功耗较高

---

### 3. Ave 平均值

**原理**:
```
BL = (pixel₁ + pixel₂ + ... + pixelₙ) / n
```

**特点**:
- 计算最简单
- 画面平滑，但可能损失对比度
- 暗场可能发灰

---

### 4. Correction 校正算法

**原理**:
```
BL = f(pixel_avg, correction_table)
```

**特点**:
- 可配置校正曲线
- 适应不同面板特性
- 灵活性最高

---

### 5. 时间滤波 (Temporal Filter)

**目的**: 防止背光亮度跳变造成闪烁

**实现**:
```verilog
// 6帧移动平均
buf_360_fore[5] <= buf_360_fore[4];
buf_360_fore[4] <= buf_360_fore[3];
...
buf_360_fore[0] <= current_frame;

// 输出平均值
output = (buf_360_fore[0] + buf_360_fore[1] + ... + buf_360_fore[5]) / 6;
```

---

## 使用指南

### 硬件连接

1. **视频输入**: 连接 LVDS 信号源到 J1/J3 排座
2. **视频输出**: 从 J2/J4 排座连接 LCD 面板
3. **LED 灯板**: 连接两块 MiniLED 灯板到 J7/J11 排座
4. **电源**: Type-C 供电

### 基本操作

#### 1. 开机默认状态
- 分区背光: 关闭 (SW1 = OFF)
- 自动亮度: 关闭 (SW2 = OFF)
- 算法模式: Mean-Corrected Max (Max)

#### 2. 开启分区背光
```
1. 将 SW1 拨到 ON
2. LED3 亮起，屏幕背光变为分区控制
3. 观察暗场画面的黑位提升
```

#### 3. 开启自动亮度
```
1. 确保 SW1 = ON (分区背光开启)
2. 将 SW2 拨到 ON
3. LED2 亮起，自动亮度生效
4. 用手遮挡光感传感器，观察背光变暗
```

#### 4. 切换算法模式
```
1. 按 KEY1 切换到 RMS 模式 (LED1:0 = 00)
2. 观察画面暗场细节
3. 按 KEY2 切换到 Max 模式 (LED1:0 = 01)
4. 对比不同算法的显示效果
```

### 推荐配置

| 场景 | SW1 | SW2 | 按键 | 效果 |
|-----|-----|-----|------|------|
| 电影观看 | ON | ON | KEY1 | 最佳画质 |
| 日常使用 | ON | ON | KEY2 | 平衡画质/功耗 |
| 对比演示 | OFF→ON | OFF | 任意 | 对比固定/分区差异 |

---

## 开发扩展

### 添加新的子模式

在 `ramflag_In.v` 中修改 `case(I_sub_mode)`:

```verilog
case(I_sub_mode)
    2'b00: // 原有模式
    2'b01: // 原有模式
    2'b10: // 新增: 自定义模式
        if (custom_condition)
            base_brightness = custom_value;
        else
            base_brightness = light_reg[wtaddr] * 255;
    2'b11: // 原有模式
default: ...
endcase
```

### 添加新的算法模式

在 `block_360_pro.v` 中:

1. 添加新的 `gray_mode` 编码
2. 在统计阶段添加新的累加逻辑
3. 在输出阶段添加新的计算公式

### 修改时间滤波参数

```verilog
// 当前是 6帧缓冲
localparam FRAME_BUFFER_DEPTH = 6;

// 可改为更多帧以获得更平滑效果
localparam FRAME_BUFFER_DEPTH = 10;
```

### 调试技巧

1. **SignalTap/逻辑分析仪**: 抓取关键信号
   - `gray_mode`: 确认算法切换
   - `zonal_en`/`auto_bright`: 确认功能开关
   - `led_light`: 观察计算出的亮度值

2. **LED 指示**: 通过 LED 状态快速判断工作模式

3. **串口输出**: 可添加 UART 模块输出调试信息

---

## 附录

### A. 管脚分配表

| 信号 | 管脚 | Bank | 电平 | 说明 |
|-----|------|------|------|------|
| I_clk | M19 | 2 | 2.5V | 50MHz 主时钟 |
| I_rst_n | AB3 | 5 | 1.5V | 复位 (低有效) |
| sw_zonal_en | W20 | 3 | 1.5V | SW1 拨码开关 |
| sw_auto_bright | V20 | 3 | 1.5V | SW2 拨码开关 |
| key_rms | T18 | 3 | 1.5V | KEY1 按键 |
| key_max | R18 | 3 | 1.5V | KEY2 按键 |
| key_ave | U20 | 3 | 1.5V | KEY3 按键 |
| key_cor | T20 | 3 | 1.5V | KEY4 按键 |
| O_led[3:0] | T17,U17,U19,U18 | 3 | 3.3V | LED 指示 |

### B. 寄存器映射

| 地址 | 名称 | 访问 | 说明 |
|-----|------|------|------|
| - | - | - | 当前设计无软件寄存器接口 |

### C. 参考资料

1. 高云 GW2A 系列 FPGA 数据手册
2. SPI7001 LED 驱动芯片规格书
3. AP3216C 光感传感器数据手册
4. LVDS 7:1 接口标准

---

**文档版本**: 1.0  
**更新日期**: 2026-02-11  
**作者**: AI Assistant
